<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absen Siswa - Sistem Akademik</title>

    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }



        body {
            font-family: 'Segoe UI', 'Open Sans', sans-serif;
            background: linear-gradient(to bottom right, #071522, #0a1f33);
            color: #f1f1f1;
            line-height: 1.6;
            min-height: 100vh;
        }



        .header {
            background: #112d4e;
            padding: 24px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.45);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: sticky;
            top: 0;
            z-index: 6;
        }



        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        }



        .container {
            max-width: 1200px;
            margin: 32px auto;
            padding: 0 24px;
        }



        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 18px;
            background: #112d4e;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.25s ease;
            font-weight: 600;
            border:1px solid rgba(255,255,255,0.08);
            box-shadow:0 8px 20px rgba(0,0,0,0.35);
        }



        .back-btn:hover {
            background: #1b3d63;
            transform: translateY(-2px);
        }



        .filter-section {
            background: rgba(17,45,78,0.92);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
        }



        .filter-section h2 {
            margin-bottom: 20px;
            font-size: 18px;
            color: #e8f4f8;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 10px;
            letter-spacing: .3px;
        }



        .filter-grid {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));

            gap: 15px;

            margin-bottom: 20px;

        }



        .filter-group {

            display: flex;

            flex-direction: column;

        }



        .filter-group label {

            font-size: 13px;

            color: #b8d4e8;

            margin-bottom: 8px;

            font-weight: 600;

            text-transform: uppercase;

            letter-spacing: 0.5px;

        }



        .filter-group select,

        .filter-group input {

            padding: 10px 12px;

            background: #0c1c2d;

            border: 1px solid rgba(255,255,255,0.08);

            border-radius: 10px;

            color: #f1faee;

            font-size: 14px;

            transition: all 0.3s ease;

        }



        .filter-group select:focus,

        .filter-group input:focus {

            outline: none;

            border-color: #3f72af;

            background: #132a42;

            box-shadow: 0 0 10px rgba(63, 114, 175, 0.35);

        }



        .search-box {

            display: flex;

            gap: 10px;

            margin-bottom: 15px;

        }



        .search-box input { flex: 1; }



        .btn-search {

            padding: 10px 20px;

            background: #3f72af;

            border: none;

            border-radius: 10px;

            color: white;

            cursor: pointer;

            font-weight: 600;

            transition: all 0.3s ease;

            box-shadow:0 8px 20px rgba(63,114,175,0.35);

        }



        .btn-search:hover {

            background: #1d4e8c;

            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);

        }



        .siswa-table {

            background: rgba(17,45,78,0.92);

            border: 1px solid rgba(255,255,255,0.08);

            border-radius: 14px;

            overflow: hidden;

            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);

        }



        table {

            width: 100%;

            border-collapse: collapse;

        }



        thead {

            background: #1b3d63;

            border-bottom: 1px solid rgba(255,255,255,0.08);

        }



        thead th {

            padding: 14px;

            text-align: left;

            font-weight: 700;

            color: #e8f4f8;

            font-size: 13px;

            text-transform: uppercase;

            letter-spacing: 0.5px;

        }



        tbody tr {

            border-bottom: 1px solid rgba(255,255,255,0.06);

            transition: all 0.2s ease;

        }



        tbody tr:nth-child(even){ background: rgba(255,255,255,0.02);}

        tbody tr:hover { background: rgba(255,255,255,0.05); }



        tbody td {

            padding: 12px 15px;

            color: #f1faee;

            font-size: 14px;

        }



        .status-select {

            padding: 8px;

            background: #0c1c2d;

            border: 1px solid rgba(255,255,255,0.08);

            border-radius: 10px;

            color: #f1faee;

            cursor: pointer;

            transition: all 0.3s ease;

        }



        .status-select:focus {

            outline: none;

            border-color: #3f72af;

            box-shadow: 0 0 8px rgba(63, 114, 175, 0.35);

        }



        .btn-save {

            padding: 8px 16px;

            background: #4ade80;

            border: none;

            border-radius: 10px;

            color: white;

            cursor: pointer;

            font-weight: 600;

            font-size: 12px;

            transition: all 0.3s ease;

        }



        .btn-save:hover {

            background: #22c55e;

            box-shadow: 0 8px 18px rgba(74, 222, 128, 0.35);

        }



        .no-data {

            text-align: center;

            padding: 40px;

            color: #c1cad6;

            display: none; /* Hidden by default */

        }



        .success-message {

            background: #10b981;

            color: white;

            padding: 12px 20px;

            border-radius: 10px;

            margin-bottom: 20px;

            display: none;

        }



        .error-message {

            background: #ef4444;

            color: white;

            padding: 12px 20px;

            border-radius: 10px;

            margin-bottom: 20px;

            display: none;

        }



        .button-group {

            display: flex;

            gap: 10px;

            justify-content: center;

            margin-top: 20px;

        }



        @media (max-width: 768px) {

            .filter-grid { grid-template-columns: 1fr; }

            .siswa-table { overflow-x: auto; }

            table { font-size: 12px; }

            thead th, tbody td { padding: 10px; }

        }

    </style>
</head>

<body>

    <!-- FORM KHUSUS UNTUK CSRF (BENAR) -->
    <form id="csrfForm" style="display:none;">
        {% csrf_token %}
    </form>

    <!-- ================== KONTEN KAMU ================== -->
     <div class="header">

        <h1>üìù Absen Siswa</h1>

    </div>



    <div class="container">

        <a href="{% url 'guru_dashboard' %}" class="back-btn">‚Üê Kembali ke Dashboard</a>



        <div id="successMessage" class="success-message"></div>

        <div id="errorMessage" class="error-message"></div>



        <div class="filter-section">

            <h2>Filter dan Pencarian</h2>

           

            <div class="search-box">

                <input

                    type="text"

                    id="searchInput"

                    placeholder="Cari nama atau NIS siswa..."

                    value="{{ search_siswa }}"

                />

                <button class="btn-search" type="button" onclick="applyFilters()">Cari</button>

            </div>



            <div class="filter-grid">

                <div class="filter-group">

                    <label for="jadwalSelect">Jadwal (Mata Pelajaran)</label>

                    <select id="jadwalSelect">

                        <option value="">-- Pilih Mata Pelajaran --</option>

                        {% for jadwal in jadwal_list %}

                        <option value="{{ jadwal.id }}" {% if jadwal.id == selected_jadwal %}selected{% endif %}>

                            {{ jadwal.mata_pelajaran }} ({{ jadwal.hari }})

                        </option>

                        {% endfor %}

                    </select>

                </div>



                <div class="filter-group">

                    <label for="kelasInput">Kelas (input manual)</label>

                    <input
                        type="text"
                        id="kelasInput"
                        placeholder="Contoh: X IPA 1"
                        value="{{ selected_kelas }}"
                    />

                </div>



                <div class="filter-group">

                    <label for="tanggalInput">Tanggal</label>

                    <input

                        type="date"

                        id="tanggalInput"

                        value="{% now 'Y-m-d' %}"

                    />

                </div>

            </div>

        </div>



        <div class="siswa-table">

            <table>

                <thead>

                    <tr>

                        <th>No</th>

                        <th>NIS</th>

                        <th>Nama Siswa</th>

                        <th>Kelas</th>

                        <th>Status Absen</th>

                        <th>Keterangan</th>

                        <th>Aksi</th>

                    </tr>

                </thead>

                <tbody id="siswaTableBody">

                    {% for siswa in siswa_list %}

                    <tr class="siswa-row" data-siswa-id="{{ siswa.nis }}" data-kelas="{{ siswa.kelas }}">


                        <td>{{ forloop.counter }}</td>

                        <td>{{ siswa.nis }}</td>

                        <td>{{ siswa.nama }}</td>

                        <td>{{ siswa.kelas }}</td>


                        <td>

                            <select class="status-select" data-siswa-id="{{ siswa.nis }}">

                                <option value="">-- Pilih Status --</option>

                                <option value="hadir">‚úì Hadir</option>

                                <option value="sakit">üè• Sakit</option>

                                <option value="izin">üìÑ Izin</option>

                                <option value="alpa">‚úó Alpa</option>

                            </select>

                        </td>

                        <td>

                            <input

                                type="text"

                                class="keterangan-input"

                                data-siswa-id="{{ siswa.nis }}"

                                placeholder="Catatan (opsional)"

                                style="width: 100%; padding: 8px; background: #0f1f2e; border: 1px solid #415a77; border-radius: 6px; color: #f1faee;"

                            />

                        </td>

                        <td>

                            <button

                                class="btn-save"

                                onclick="saveAbsen('{{ siswa.nis }}', this)"

                            >

                                Simpan

                            </button>

                        </td>

                    </tr>

                    {% empty %}

                    <tr>

                        <td colspan="7" style="text-align: center; padding: 20px;">Belum ada data siswa.</td>

                    </tr>

                    {% endfor %}

                </tbody>

            </table>

           

            <div id="noDataMessage" class="no-data">

                <p>Tidak ada siswa di kelas ini.</p>

            </div>

        </div>



        <div class="button-group">

            <button class="btn-search" type="button" onclick="markAllHadir()" style="background: #10b981;">

                ‚úî Hadir Semua

            </button>

            <button class="btn-search" type="button" onclick="saveAllAbsen()" style="background: #3b82f6;">

                üíæ Simpan Semua Absen (Yang Terisi)

            </button>

        </div>

    </div>
    <!-- ================================================= -->

    <script>
    const csrftoken = document.querySelector('#csrfForm input[name=csrfmiddlewaretoken]').value;

    // 1. Apply filter
    function applyFilters() {
        const search = document.getElementById('searchInput').value;
        const kelas = document.getElementById('kelasInput').value;
        const jadwal = document.getElementById('jadwalSelect').value;

        const params = new URLSearchParams();
        if (search) params.set('search', search);
        if (kelas) params.set('kelas', kelas);
        if (jadwal) params.set('jadwal', jadwal);

        const query = params.toString();
        window.location.href = query ? `?${query}` : window.location.pathname;
    }

    // 2. Simpan satu siswa
    function saveAbsen(siswaId, button) {
        const jadwal = document.getElementById('jadwalSelect').value;
        const tanggal = document.getElementById('tanggalInput').value;

        const status = document.querySelector(`.status-select[data-siswa-id="${siswaId}"]`).value;
        const keterangan = document.querySelector(`.keterangan-input[data-siswa-id="${siswaId}"]`).value;

        if (!jadwal) return showError("Silakan pilih jadwal!");
        if (!status) return showError("Silakan pilih status!");

        const formData = new FormData();
        formData.append('siswa_id', siswaId);
        formData.append('jadwal_id', jadwal);
        formData.append('tanggal', tanggal);
        formData.append('status', status);
        formData.append('keterangan', keterangan);

        const originalText = button.innerText;
        button.innerText = "...";
        button.disabled = true;

        fetch("{% url 'absen_siswa' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": csrftoken }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showSuccess(`Absen NIS ${siswaId} berhasil disimpan`);
                button.style.background = "#10b981";
            } else {
                showError(data.message);
            }
        })
        .catch(() => showError("Kesalahan koneksi"))
        .finally(() => {
            button.innerText = originalText;
            button.disabled = false;
            setTimeout(() => (button.style.background = "#4ade80"), 2000);
        });
    }

    // 3. Simpan semua
    function saveAllAbsen() {
        const jadwal = document.getElementById('jadwalSelect').value;
        const tanggal = document.getElementById('tanggalInput').value;

        if (!jadwal) return showError("Silakan pilih jadwal!");

        const rows = document.querySelectorAll('.siswa-row');
        const records = [];

        rows.forEach(row => {
            if (row.style.display === 'none') return;

            const siswaId = row.getAttribute('data-siswa-id');
            const status = document.querySelector(`.status-select[data-siswa-id="${siswaId}"]`).value;
            const keterangan = document.querySelector(`.keterangan-input[data-siswa-id="${siswaId}"]`).value;

            if (!status) return;
            records.push({ siswa_id: siswaId, status, keterangan });
        });

        if (!records.length) return showError("Tidak ada absen yang bisa disimpan.");

        fetch("{% url 'absen_siswa' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({
                jadwal_id: jadwal,
                tanggal,
                records
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                showSuccess(`Tersimpan: ${data.created} baru, ${data.updated} diperbarui`);
            } else {
                showError(data.message || "Gagal menyimpan absen");
            }
        })
        .catch(() => showError("Kesalahan koneksi"));
    }

    // Hadir semua
    function markAllHadir() {
        document.querySelectorAll('.status-select').forEach(sel => {
            sel.value = 'hadir';
        });
        showSuccess("Semua status diset menjadi Hadir. Jangan lupa simpan.");
    }

    function showSuccess(msg) {
        const m = document.getElementById("successMessage");
        m.textContent = msg;
        m.style.display = "block";
        setTimeout(() => m.style.display = "none", 3000);
    }

    function showError(msg) {
        const m = document.getElementById("errorMessage");
        m.textContent = msg;
        m.style.display = "block";
        setTimeout(() => m.style.display = "none", 3000);
    }

    document.getElementById('searchInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyFilters();
    });
    document.getElementById('kelasInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyFilters();
    });
</script>

</body>
</html>
